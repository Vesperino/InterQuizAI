<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - InterQuizAI</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/quiz.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">InterQuizAI</div>
        <div class="nav-right">
            <ul class="nav-links">
                <li><a href="/" data-i18n="nav.start">Start</a></li>
                <li><a href="/pages/history.html" data-i18n="nav.history">Historia</a></li>
                <li><a href="/pages/languages.html" data-i18n="nav.languages">Języki</a></li>
                <li><a href="/pages/config.html" data-i18n="nav.settings">Ustawienia</a></li>
            </ul>
            <div class="lang-switcher">
                <select id="lang-switcher" onchange="I18n.setLanguage(this.value)">
                    <option value="pl">PL</option>
                    <option value="en">EN</option>
                </select>
            </div>
        </div>
    </nav>

    <main class="container quiz-container">
        <div class="quiz-header">
            <div class="quiz-info">
                <span id="quiz-language"></span>
                <span id="quiz-category"></span>
                <span id="quiz-difficulty"></span>
            </div>
            <div class="quiz-progress">
                <div class="quiz-progress-text">
                    <span><span data-i18n="quiz.question">Pytanie</span> <span id="current-q">1</span> <span data-i18n="quiz.of">z</span> <span id="total-q">20</span></span>
                    <span id="answered-count">0 <span data-i18n="quiz.answers">odpowiedzi</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 5%;"></div>
                </div>
            </div>
        </div>

        <div class="question-card" id="question-card">
            <div class="question-number" id="question-number"></div>
            <div class="question-text" id="question-text">
                Loading...
            </div>

            <div class="answers-list" id="answers-list">
                <!-- Answers loaded dynamically -->
            </div>

            <div class="question-actions">
                <button class="btn btn-secondary" id="prev-btn" disabled>
                    &larr; <span data-i18n="quiz.prev">Poprzednie</span>
                </button>
                <div>
                    <button class="btn btn-secondary" id="skip-btn" data-i18n="quiz.skip">
                        Pomiń
                    </button>
                    <button class="btn btn-primary" id="next-btn">
                        <span data-i18n="quiz.next">Następne</span> &rarr;
                    </button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-success" id="finish-btn" style="display: none;" data-i18n="quiz.finish">
                Zakończ Quiz i zobacz wyniki
            </button>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/i18n.js"></script>
    <script>
        let sessionGuid = null;
        let currentQuestion = 1;
        let totalQuestions = 20;
        let answers = {}; // questionId -> answerId
        let questions = []; // cached questions

        // Convert markdown code blocks to HTML
        function formatCodeBlocks(text) {
            if (!text) return '';

            // Escape HTML first
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Convert code blocks: ```language\ncode\n``` -> <pre><code>code</code></pre>
            escaped = escaped.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`;
            });

            // Convert inline code: `code` -> <code>code</code>
            escaped = escaped.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Convert newlines to <br> (but not inside pre tags)
            escaped = escaped.replace(/\n(?![^<]*<\/pre>)/g, '<br>');

            return escaped;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            sessionGuid = params.get('session');

            if (!sessionGuid) {
                window.location.href = '/';
                return;
            }

            await loadSession();
            await loadQuestion(1);
            setupEventListeners();
        });

        async function loadSession() {
            const session = await InterQuizAPI.getSession(sessionGuid);
            document.getElementById('quiz-language').textContent = session.language;
            document.getElementById('quiz-category').textContent = session.category;
            document.getElementById('quiz-difficulty').textContent = session.difficultyLevel;
            totalQuestions = session.totalQuestions;
            document.getElementById('total-q').textContent = totalQuestions;
        }

        async function loadQuestion(num) {
            currentQuestion = num;
            document.getElementById('current-q').textContent = num;
            document.getElementById('question-number').textContent = `${I18n.t('quiz.question')} ${num}`;
            document.getElementById('progress-fill').style.width = `${(num / totalQuestions) * 100}%`;

            // Update buttons
            document.getElementById('prev-btn').disabled = num === 1;
            document.getElementById('next-btn').style.display = num === totalQuestions ? 'none' : 'inline-flex';
            document.getElementById('finish-btn').style.display = num === totalQuestions ? 'inline-flex' : 'none';

            const question = await InterQuizAPI.getQuestion(sessionGuid, num);
            questions[num] = question;

            document.getElementById('question-text').innerHTML = formatCodeBlocks(question.questionText);

            const answersContainer = document.getElementById('answers-list');
            answersContainer.innerHTML = '';

            const letters = ['A', 'B', 'C', 'D', 'E'];
            question.answers.forEach((answer, index) => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                if (answers[question.questionId] === answer.id) {
                    div.classList.add('selected');
                }
                div.dataset.answerId = answer.id;
                div.dataset.questionId = question.questionId;
                div.innerHTML = `
                    <span class="answer-letter">${letters[index]}</span>
                    <span class="answer-text">${formatCodeBlocks(answer.text)}</span>
                `;
                div.addEventListener('click', () => selectAnswer(div, question.questionId, answer.id));
                answersContainer.appendChild(div);
            });

            updateAnsweredCount();
        }

        function selectAnswer(element, questionId, answerId) {
            // Remove selection from other answers
            document.querySelectorAll('.answer-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            answers[questionId] = answerId;

            // Submit answer to server
            InterQuizAPI.submitAnswer(sessionGuid, questionId, answerId);
            updateAnsweredCount();
        }

        function updateAnsweredCount() {
            const count = Object.keys(answers).length;
            document.getElementById('answered-count').innerHTML = `${count} ${I18n.t('quiz.answers')}`;
        }

        function setupEventListeners() {
            document.getElementById('prev-btn').addEventListener('click', () => {
                if (currentQuestion > 1) {
                    loadQuestion(currentQuestion - 1);
                }
            });

            document.getElementById('next-btn').addEventListener('click', () => {
                if (currentQuestion < totalQuestions) {
                    loadQuestion(currentQuestion + 1);
                }
            });

            document.getElementById('skip-btn').addEventListener('click', () => {
                if (currentQuestion < totalQuestions) {
                    loadQuestion(currentQuestion + 1);
                }
            });

            document.getElementById('finish-btn').addEventListener('click', async () => {
                if (confirm(I18n.t('quiz.confirmFinish'))) {
                    await InterQuizAPI.completeQuiz(sessionGuid);
                    window.location.href = `/pages/results.html?session=${sessionGuid}`;
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && currentQuestion > 1) {
                    loadQuestion(currentQuestion - 1);
                } else if (e.key === 'ArrowRight' && currentQuestion < totalQuestions) {
                    loadQuestion(currentQuestion + 1);
                } else if (e.key >= '1' && e.key <= '5') {
                    const index = parseInt(e.key) - 1;
                    const answerOptions = document.querySelectorAll('.answer-option');
                    if (answerOptions[index]) {
                        answerOptions[index].click();
                    }
                }
            });
        }
    </script>
</body>
</html>
